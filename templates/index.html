<!DOCTYPE html>
<html>
<head>
    <title>Mark Business Finder HEHE</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
        body { background: #f1f3f5; }

        .preloader {
            display: none;
            position: fixed;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .logo-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
        }

        .phone {
            white-space: nowrap;
        }
    </style>
</head>

<body class="container py-4">

<h3 class="mb-4">Business Finder</h3>

<div class="preloader" id="preloader">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Select Business Types</label><br>

    <input type="checkbox" class="btn-check" id="manufacturing" value="manufacturing">
    <label class="btn btn-outline-primary me-2" for="manufacturing">Manufacturing</label>

    <input type="checkbox" class="btn-check" id="technology" value="technology">
    <label class="btn btn-outline-success me-2" for="technology">Technology</label>

    <input type="checkbox" class="btn-check" id="warehouse" value="warehouse">
    <label class="btn btn-outline-warning me-2" for="warehouse">Warehouse</label>

    <input type="checkbox" class="btn-check" id="factory" value="factory">
    <label class="btn btn-outline-danger me-2" for="factory">Factory</label>

    <input type="checkbox" class="btn-check" id="restaurant" value="restaurant">
    <label class="btn btn-outline-info me-2" for="restaurant">Restaurant</label>

    <input type="checkbox" class="btn-check" id="cafe" value="cafe">
    <label class="btn btn-outline-secondary me-2" for="cafe">Cafe</label>

    <input type="checkbox" class="btn-check" id="hotel" value="hotel">
    <label class="btn btn-outline-dark me-2" for="hotel">Hotel</label>

    <input type="checkbox" class="btn-check" id="shop" value="shop">
    <label class="btn btn-outline-success me-2" for="shop">Shop</label>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <input id="location" class="form-control" placeholder="Enter city (e.g. Manila)">
    </div>
    <div class="col-md-4">
        <button id="search" class="btn btn-primary w-100">Search</button>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-striped" id="results-table">
        <thead class="table-dark">
            <tr>
                <th>Type</th>
                <th>Logo</th>
                <th>Name</th>
                <th>Address</th>
                <th>Phone</th>
                <th>Website</th>
                <th>Map</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
$(document).ready(function() {
    let table = $('#results-table').DataTable({
        columnDefs: [
            { orderable: false, targets: [1, 6] }
        ]
    });

    $("#search").click(function () {
        let selected = $("input[type=checkbox]:checked").map(function(){ 
            return this.value; 
        }).get();

        if (selected.length === 0) {
            alert("Please select at least one business type");
            return;
        }

        $("#preloader").css("display", "flex");
        table.clear().draw();

        $.post("/search", {
            location: $("#location").val(),
            business_types: selected.join(",")
        })
        .done(function(data) {
            Object.keys(data).forEach(type => {
                data[type].forEach(item => {
                    if (!item.name) return;

                    let logoHtml = `<img src="${item.logo}" class="logo-thumb">`;

                    let phoneHtml = item.phone
                        ? `<a href="tel:${item.phone}" class="phone">${item.phone}</a>`
                        : `<span class="text-muted">N/A</span>`;

                    let websiteHtml = item.website
                        ? `<a href="${item.website}" target="_blank">${item.website}</a>`
                        : '';

                    let mapHtml = `
                        <a href="https://www.openstreetmap.org/?mlat=${item.lat}&mlon=${item.lon}" 
                           target="_blank">View Map</a>
                    `;

                    table.row.add([
                        type,
                        logoHtml,
                        item.name,
                        item.address,
                        phoneHtml,
                        websiteHtml,
                        mapHtml
                    ]).draw(false);
                });
            });
        })
        .fail(function() {
            alert("Error fetching data from server.");
        })
        .always(function() {
            $("#preloader").hide();
        });
    });
});
</script>

</body>
</html>
